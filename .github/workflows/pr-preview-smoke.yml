name: pr-preview-smoke

on:
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review]

permissions:
  contents: read
  deployments: read

concurrency:
  group: pr-preview-smoke-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  smoke:
    runs-on: ubuntu-latest
    steps:
      - name: Resolve preview URL from deployments
        id: preview
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          PR_HEAD_SHA: ${{ github.event.pull_request.head.sha }}
        run: |
          python3 - <<'PY'
          import json
          import os
          import time
          import urllib.parse
          import urllib.request

          token = os.environ["GITHUB_TOKEN"]
          repo = os.environ["GITHUB_REPOSITORY"]
          head_sha = os.environ["PR_HEAD_SHA"]

          api_base = f"https://api.github.com/repos/{repo}"
          headers = {
              "Authorization": f"Bearer {token}",
              "Accept": "application/vnd.github+json",
              "X-GitHub-Api-Version": "2022-11-28",
              "User-Agent": "codex-pr-preview-smoke",
          }

          def gh_json(url):
              req = urllib.request.Request(url, headers=headers, method="GET")
              with urllib.request.urlopen(req) as r:
                  return json.loads(r.read().decode())

          preview_url = ""
          for _ in range(18):
              q = urllib.parse.urlencode({"sha": head_sha, "per_page": 100})
              deployments = gh_json(f"{api_base}/deployments?{q}")
              for dep in deployments:
                  dep_id = dep.get("id")
                  if not dep_id:
                      continue
                  statuses = gh_json(f"{api_base}/deployments/{dep_id}/statuses?per_page=100")
                  for status in statuses:
                      env_url = status.get("environment_url")
                      if env_url and "onrender.com" in env_url:
                          preview_url = env_url.rstrip("/")
                          break
                  if preview_url:
                      break
              if preview_url:
                  break
              time.sleep(10)

          out = os.environ["GITHUB_OUTPUT"]
          with open(out, "a", encoding="utf-8") as fh:
              fh.write(f"preview_url={preview_url}\n")
          PY

      - name: Skip when preview URL is unavailable
        if: steps.preview.outputs.preview_url == ''
        run: |
          echo "No Render preview URL found for this PR SHA yet."
          echo "Skipping smoke checks."

      - name: Smoke test Render preview routes
        if: steps.preview.outputs.preview_url != ''
        env:
          PREVIEW_URL: ${{ steps.preview.outputs.preview_url }}
        run: |
          set -euo pipefail
          echo "Testing preview: ${PREVIEW_URL}"

          check_ok_or_redirect_with_retry() {
            local path="$1"
            local code=""
            for _ in {1..18}; do
              code="$(curl -sS -o /dev/null -w "%{http_code}" "${PREVIEW_URL}${path}")"
              echo "${path} -> ${code}"
              if [ "${code}" = "200" ] || [ "${code}" = "302" ]; then
                return 0
              fi
              sleep 10
            done

            echo "Unexpected status for ${path} after retries: ${code}"
            exit 1
          }

          # Public landing page
          check_ok_or_redirect_with_retry "/"

          # Signup page must not return 500
          check_ok_or_redirect_with_retry "/registration/new"

          # Auth-protected index should redirect when logged out
          check_ok_or_redirect_with_retry "/projects"
