name: ci

on:
  pull_request:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  security:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          bundler-cache: true

      - name: Brakeman
        run: bin/brakeman --no-pager

      - name: Bundler Audit
        run: bin/bundler-audit --update

  lint:
    runs-on: ubuntu-latest
    env:
      RUBOCOP_CACHE_ROOT: tmp/rubocop
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          bundler-cache: true

      - name: RuboCop
        run: bin/rubocop

  test:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: auto_codex_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    env:
      RAILS_ENV: test
      DATABASE_URL: postgres://postgres:postgres@localhost:5432/auto_codex_test

    steps:
      - name: Install libpq
        run: sudo apt-get update && sudo apt-get install --no-install-recommends -y libpq-dev

      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          bundler-cache: true

      - name: Run RSpec
        run: |
          bin/rails db:prepare
          bundle exec rspec

  deploy-render:
    runs-on: ubuntu-latest
    needs: [security, lint, test]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Trigger Render deploy
        id: trigger
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ vars.RENDER_SERVICE_ID }}
          COMMIT_SHA: ${{ github.sha }}
        run: |
          set -euo pipefail
          if [ -z "${RENDER_API_KEY:-}" ]; then
            echo "Missing GitHub secret: RENDER_API_KEY"
            exit 1
          fi
          if [ -z "${RENDER_SERVICE_ID:-}" ]; then
            echo "Missing GitHub variable: RENDER_SERVICE_ID"
            exit 1
          fi

          response="$(curl -sS -X POST "https://api.render.com/v1/services/${RENDER_SERVICE_ID}/deploys" \
            -H "Authorization: Bearer ${RENDER_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "{\"commitId\":\"${COMMIT_SHA}\"}")"

          deploy_id="$(echo "${response}" | jq -r '.id // empty')"
          if [ -z "${deploy_id}" ]; then
            echo "Failed to trigger Render deploy:"
            echo "${response}"
            exit 1
          fi

          echo "Triggered Render deploy: ${deploy_id}"
          echo "deploy_id=${deploy_id}" >> "${GITHUB_OUTPUT}"

      - name: Wait for Render deploy
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ vars.RENDER_SERVICE_ID }}
          DEPLOY_ID: ${{ steps.trigger.outputs.deploy_id }}
        run: |
          set -euo pipefail
          echo "Polling Render deploy ${DEPLOY_ID}"
          for _ in {1..90}; do
            status="$(curl -sS -H "Authorization: Bearer ${RENDER_API_KEY}" \
              "https://api.render.com/v1/services/${RENDER_SERVICE_ID}/deploys/${DEPLOY_ID}" | jq -r '.status')"

            echo "Render status: ${status}"

            if [ "${status}" = "live" ]; then
              echo "Render deploy is live."
              exit 0
            fi

            if [ "${status}" = "build_failed" ] || [ "${status}" = "update_failed" ] || [ "${status}" = "canceled" ] || [ "${status}" = "deactivated" ]; then
              echo "Render deploy failed with status: ${status}"
              exit 1
            fi

            sleep 10
          done

          echo "Timed out waiting for Render deploy to reach live status."
          exit 1
